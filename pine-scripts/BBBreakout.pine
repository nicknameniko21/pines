//@version=5
indicator("Bollinger Bands Breakout", shorttitle="BB Breakout", overlay=true, max_bars_back=500)

// ════════════════════════════════════════════════════════════════════════
// INPUT PARAMETERS
// ════════════════════════════════════════════════════════════════════════

// Bollinger Bands Settings
bbLength = input.int(20, title="BB Length", minval=1, group="Bollinger Bands")
bbMult = input.float(2.0, title="BB Multiplier", minval=0.1, step=0.1, group="Bollinger Bands")
bbSource = input.source(close, title="BB Source", group="Bollinger Bands")

// Squeeze Detection
squeezeLength = input.int(100, title="Squeeze Lookback Period", minval=10, group="Squeeze Detection", tooltip="Periods to look back for bandwidth comparison")
squeezeThreshold = input.float(20, title="Squeeze Threshold %", minval=0, step=5, group="Squeeze Detection", tooltip="Bandwidth below this percentile triggers squeeze alert")

// Volume Confirmation
volumeEnable = input.bool(true, title="Require Volume Confirmation", group="Volume Settings")
volumeMALength = input.int(20, title="Volume MA Length", minval=1, group="Volume Settings")
volumeMultiplier = input.float(1.5, title="Volume Multiplier", minval=0.5, step=0.1, group="Volume Settings", tooltip="Breakout requires volume this many times average")

// Breakout Settings
breakoutStrength = input.float(0.5, title="Min Breakout Strength %", minval=0.1, step=0.1, group="Breakout Settings", tooltip="Price must break bands by this percentage")
consecutiveBars = input.int(2, title="Consecutive Close Bars", minval=1, maxval=5, group="Breakout Settings", tooltip="Number of consecutive closes outside bands to confirm breakout")

// Display Settings
showBands = input.bool(true, title="Show Bollinger Bands", group="Display")
showSqueeze = input.bool(true, title="Show Squeeze Signals", group="Display")
showBreakout = input.bool(true, title="Show Breakout Signals", group="Display")
showZones = input.bool(true, title="Show Breakout Zones", group="Display")

// Alert Settings
enableAlerts = input.bool(true, title="Enable Alerts", group="Alerts")

// ════════════════════════════════════════════════════════════════════════
// BOLLINGER BANDS CALCULATION
// ════════════════════════════════════════════════════════════════════════

// Calculate Bollinger Bands
basis = ta.sma(bbSource, bbLength)
dev = bbMult * ta.stdev(bbSource, bbLength)
upperBand = basis + dev
lowerBand = basis - dev

// Calculate Bandwidth (volatility measure)
bandwidth = ((upperBand - lowerBand) / basis) * 100

// Calculate %B (position within bands)
percentB = (bbSource - lowerBand) / (upperBand - lowerBand)

// ════════════════════════════════════════════════════════════════════════
// SQUEEZE DETECTION
// ════════════════════════════════════════════════════════════════════════

// Calculate bandwidth percentile
bandwidthRank = 0.0
for i = 0 to squeezeLength - 1
    if bandwidth > bandwidth[i]
        bandwidthRank := bandwidthRank + 1

bandwidthPercentile = (bandwidthRank / squeezeLength) * 100

// Squeeze detected when bandwidth is in lower percentile
inSqueeze = bandwidthPercentile < squeezeThreshold
squeezeTrigger = inSqueeze and not inSqueeze[1]

// ════════════════════════════════════════════════════════════════════════
// VOLUME ANALYSIS
// ════════════════════════════════════════════════════════════════════════

volumeMA = ta.sma(volume, volumeMALength)
highVolume = volume > (volumeMA * volumeMultiplier)

// ════════════════════════════════════════════════════════════════════════
// BREAKOUT DETECTION
// ════════════════════════════════════════════════════════════════════════

// Calculate breakout strength
upperBreakStrength = ((close - upperBand) / upperBand) * 100
lowerBreakStrength = ((lowerBand - close) / lowerBand) * 100

// Check if price closed outside bands
closedAboveBand = close > upperBand and upperBreakStrength >= breakoutStrength
closedBelowBand = close < lowerBand and lowerBreakStrength >= breakoutStrength

// Count consecutive closes outside bands
var int consecutiveAbove = 0
var int consecutiveBelow = 0

if closedAboveBand
    consecutiveAbove := consecutiveAbove + 1
    consecutiveBelow := 0
else if closedBelowBand
    consecutiveBelow := consecutiveBelow + 1
    consecutiveAbove := 0
else
    consecutiveAbove := 0
    consecutiveBelow := 0

// Breakout confirmed after consecutive closes
bullishBreakout = consecutiveAbove == consecutiveBars and (not volumeEnable or highVolume)
bearishBreakout = consecutiveBelow == consecutiveBars and (not volumeEnable or highVolume)

// Enhanced breakout: after squeeze
bullishBreakoutAfterSqueeze = bullishBreakout and inSqueeze[consecutiveBars]
bearishBreakoutAfterSqueeze = bearishBreakout and inSqueeze[consecutiveBars]

// ════════════════════════════════════════════════════════════════════════
// TREND DETERMINATION
// ════════════════════════════════════════════════════════════════════════

// Trend based on price position relative to bands
trend = percentB > 0.8 ? 1 : percentB < 0.2 ? -1 : 0

// ════════════════════════════════════════════════════════════════════════
// PLOTTING
// ════════════════════════════════════════════════════════════════════════

// Plot Bollinger Bands
plot(showBands ? basis : na, title="Basis", color=color.new(color.blue, 0), linewidth=2)
upperPlot = plot(showBands ? upperBand : na, title="Upper Band", color=color.new(color.red, 50), linewidth=1)
lowerPlot = plot(showBands ? lowerBand : na, title="Lower Band", color=color.new(color.green, 50), linewidth=1)

// Fill between bands
fill(upperPlot, lowerPlot, color=color.new(color.gray, 95), title="BB Fill")

// Highlight squeeze zones
bgcolor(showSqueeze and inSqueeze ? color.new(color.yellow, 90) : na, title="Squeeze Zone")

// Plot squeeze trigger
plotshape(
    showSqueeze and squeezeTrigger ? low : na,
    title="Squeeze Alert",
    location=location.belowbar,
    color=color.new(color.orange, 0),
    style=shape.circle,
    size=size.tiny,
    text="SQ"
)

// Plot breakout signals
plotshape(
    showBreakout and bullishBreakout ? low : na,
    title="Bullish Breakout",
    location=location.belowbar,
    color=color.new(color.green, 0),
    style=shape.labelup,
    text="BUY",
    textcolor=color.white,
    size=size.small
)

plotshape(
    showBreakout and bearishBreakout ? high : na,
    title="Bearish Breakout",
    location=location.abovebar,
    color=color.new(color.red, 0),
    style=shape.labeldown,
    text="SELL",
    textcolor=color.white,
    size=size.small
)

// Special markers for breakouts after squeeze (high probability)
plotshape(
    showBreakout and bullishBreakoutAfterSqueeze ? low : na,
    title="Bullish Breakout (Post-Squeeze)",
    location=location.belowbar,
    color=color.new(color.lime, 0),
    style=shape.triangleup,
    size=size.normal,
    text="STRONG\nBUY"
)

plotshape(
    showBreakout and bearishBreakoutAfterSqueeze ? high : na,
    title="Bearish Breakout (Post-Squeeze)",
    location=location.abovebar,
    color=color.new(color.maroon, 0),
    style=shape.triangledown,
    size=size.normal,
    text="STRONG\nSELL"
)

// ════════════════════════════════════════════════════════════════════════
// BREAKOUT ZONES
// ════════════════════════════════════════════════════════════════════════

// Draw zones for potential breakout targets
var line upperTarget = na
var line lowerTarget = na

if showZones
    if bullishBreakout
        // Target is next resistance (2x bandwidth above upper band)
        targetPrice = upperBand + (2 * dev)
        line.delete(upperTarget)
        upperTarget := line.new(bar_index, targetPrice, bar_index + 20, targetPrice, 
                                color=color.new(color.green, 50), style=line.style_dashed, width=2)
    
    if bearishBreakout
        // Target is next support (2x bandwidth below lower band)
        targetPrice = lowerBand - (2 * dev)
        line.delete(lowerTarget)
        lowerTarget := line.new(bar_index, targetPrice, bar_index + 20, targetPrice, 
                                color=color.new(color.red, 50), style=line.style_dashed, width=2)

// ════════════════════════════════════════════════════════════════════════
// ALERTS
// ════════════════════════════════════════════════════════════════════════

if enableAlerts
    if squeezeTrigger
        alert("BB Squeeze detected! Low volatility period may lead to explosive breakout soon.", alert.freq_once_per_bar_close)
    
    if bullishBreakoutAfterSqueeze
        alert("HIGH PROBABILITY Bullish Breakout! Price broke above Bollinger Bands after squeeze with high volume.", alert.freq_once_per_bar_close)
    else if bullishBreakout
        alert("Bullish Breakout! Price closed above upper Bollinger Band.", alert.freq_once_per_bar_close)
    
    if bearishBreakoutAfterSqueeze
        alert("HIGH PROBABILITY Bearish Breakout! Price broke below Bollinger Bands after squeeze with high volume.", alert.freq_once_per_bar_close)
    else if bearishBreakout
        alert("Bearish Breakout! Price closed below lower Bollinger Band.", alert.freq_once_per_bar_close)

// ════════════════════════════════════════════════════════════════════════
// INFO TABLE
// ════════════════════════════════════════════════════════════════════════

var table infoTable = table.new(position.top_right, 2, 7, bgcolor=color.new(color.gray, 90), border_width=1)

if barstate.islast
    table.cell(infoTable, 0, 0, "BB Breakout Detector", text_color=color.white, bgcolor=color.new(color.blue, 30))
    table.merge_cells(infoTable, 0, 0, 1, 0)
    
    table.cell(infoTable, 0, 1, "Bandwidth:", text_color=color.white)
    table.cell(infoTable, 1, 1, str.tostring(bandwidth, "#.##") + "%", text_color=color.gray)
    
    table.cell(infoTable, 0, 2, "Percentile:", text_color=color.white)
    table.cell(infoTable, 1, 2, str.tostring(bandwidthPercentile, "#.#") + "%", text_color=color.gray)
    
    table.cell(infoTable, 0, 3, "Squeeze:", text_color=color.white)
    squeezeText = inSqueeze ? "YES (!)" : "No"
    table.cell(infoTable, 1, 3, squeezeText, text_color=inSqueeze ? color.orange : color.gray)
    
    table.cell(infoTable, 0, 4, "%B Position:", text_color=color.white)
    pbColor = percentB > 1 ? color.red : percentB < 0 ? color.green : color.gray
    table.cell(infoTable, 1, 4, str.tostring(percentB, "#.##"), text_color=pbColor)
    
    table.cell(infoTable, 0, 5, "Volume:", text_color=color.white)
    volumeText = highVolume ? "HIGH" : "Normal"
    table.cell(infoTable, 1, 5, volumeText, text_color=highVolume ? color.green : color.gray)
    
    table.cell(infoTable, 0, 6, "Trend:", text_color=color.white)
    trendText = trend > 0 ? "Bullish" : trend < 0 ? "Bearish" : "Neutral"
    trendColor = trend > 0 ? color.green : trend < 0 ? color.red : color.gray
    table.cell(infoTable, 1, 6, trendText, text_color=trendColor)
