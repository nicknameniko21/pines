//@version=5
indicator("RSI Divergence Signals", shorttitle="RSI Div", overlay=true, max_bars_back=500)

// ════════════════════════════════════════════════════════════════════════
// INPUT PARAMETERS
// ════════════════════════════════════════════════════════════════════════

// RSI Settings
rsiLength = input.int(14, title="RSI Length", minval=1, group="RSI Settings")
rsiSource = input.source(close, title="RSI Source", group="RSI Settings")

// Divergence Detection Settings
pivotLookback = input.int(5, title="Pivot Lookback", minval=1, group="Divergence Settings", tooltip="Number of bars to look back for pivot points")
maxLookback = input.int(60, title="Max Lookback Range", minval=10, group="Divergence Settings", tooltip="Maximum bars to look back for divergence patterns")
minDivergenceStrength = input.float(5.0, title="Min Divergence Strength", minval=0, step=0.5, group="Divergence Settings", tooltip="Minimum percentage difference required for valid divergence")

// Display Settings
showBullishDiv = input.bool(true, title="Show Bullish Divergence", group="Display")
showBearishDiv = input.bool(true, title="Show Bearish Divergence", group="Display")
showRSILine = input.bool(true, title="Show RSI Line", group="Display")
showLabels = input.bool(true, title="Show Divergence Labels", group="Display")

// Alert Settings
enableAlerts = input.bool(true, title="Enable Alerts", group="Alerts")

// ════════════════════════════════════════════════════════════════════════
// RSI CALCULATION
// ════════════════════════════════════════════════════════════════════════

rsi = ta.rsi(rsiSource, rsiLength)

// ════════════════════════════════════════════════════════════════════════
// PIVOT DETECTION
// ════════════════════════════════════════════════════════════════════════

// Find pivot highs and lows
pivotHigh = ta.pivothigh(high, pivotLookback, pivotLookback)
pivotLow = ta.pivotlow(low, pivotLookback, pivotLookback)

// Store pivot values
var float lastPivotHigh = na
var int lastPivotHighBar = na
var float lastRSIHigh = na

var float lastPivotLow = na
var int lastPivotLowBar = na
var float lastRSILow = na

// Update pivot highs
if not na(pivotHigh)
    lastPivotHigh := pivotHigh
    lastPivotHighBar := bar_index - pivotLookback
    lastRSIHigh := rsi[pivotLookback]

// Update pivot lows
if not na(pivotLow)
    lastPivotLow := pivotLow
    lastPivotLowBar := bar_index - pivotLookback
    lastRSILow := rsi[pivotLookback]

// ════════════════════════════════════════════════════════════════════════
// DIVERGENCE DETECTION
// ════════════════════════════════════════════════════════════════════════

// Bullish Divergence (Price makes lower low, RSI makes higher low)
bullishDivergence = false
bearishDivergence = false

// Current pivot detection
currentPivotHigh = ta.pivothigh(high, pivotLookback, pivotLookback)
currentPivotLow = ta.pivotlow(low, pivotLookback, pivotLookback)

if not na(currentPivotLow) and not na(lastPivotLow)
    currentLow = low[pivotLookback]
    currentRSILow = rsi[pivotLookback]
    
    barsBack = bar_index - lastPivotLowBar - pivotLookback
    
    // Check if within lookback range
    if barsBack > 0 and barsBack <= maxLookback
        // Price makes lower low, RSI makes higher low
        priceLower = currentLow < lastPivotLow
        rsiHigher = currentRSILow > lastRSILow
        
        // Calculate strength
        priceChange = ((lastPivotLow - currentLow) / currentLow) * 100
        rsiChange = currentRSILow - lastRSILow
        
        if priceLower and rsiHigher and priceChange >= minDivergenceStrength
            bullishDivergence := true

if not na(currentPivotHigh) and not na(lastPivotHigh)
    currentHigh = high[pivotLookback]
    currentRSIHigh = rsi[pivotLookback]
    
    barsBack = bar_index - lastPivotHighBar - pivotLookback
    
    // Check if within lookback range
    if barsBack > 0 and barsBack <= maxLookback
        // Price makes higher high, RSI makes lower high
        priceHigher = currentHigh > lastPivotHigh
        rsiLower = currentRSIHigh < lastRSIHigh
        
        // Calculate strength
        priceChange = ((currentHigh - lastPivotHigh) / lastPivotHigh) * 100
        rsiChange = lastRSIHigh - currentRSIHigh
        
        if priceHigher and rsiLower and priceChange >= minDivergenceStrength
            bearishDivergence := true

// ════════════════════════════════════════════════════════════════════════
// PLOTTING
// ════════════════════════════════════════════════════════════════════════

// Plot RSI line in a separate pane
rsiPlot = plot(showRSILine ? rsi : na, title="RSI", color=color.new(color.blue, 0), linewidth=2)
hline(70, "Overbought", color=color.new(color.red, 50), linestyle=hline.style_dashed)
hline(50, "Midline", color=color.new(color.gray, 80), linestyle=hline.style_dotted)
hline(30, "Oversold", color=color.new(color.green, 50), linestyle=hline.style_dashed)

// Plot divergence signals on main chart
plotshape(
    showBullishDiv and bullishDivergence ? low[pivotLookback] : na,
    title="Bullish Divergence",
    location=location.belowbar,
    color=color.new(color.green, 0),
    style=shape.labelup,
    text="BULL\nDIV",
    textcolor=color.white,
    size=size.small
)

plotshape(
    showBearishDiv and bearishDivergence ? high[pivotLookback] : na,
    title="Bearish Divergence",
    location=location.abovebar,
    color=color.new(color.red, 0),
    style=shape.labeldown,
    text="BEAR\nDIV",
    textcolor=color.white,
    size=size.small
)

// Draw divergence lines
if showBullishDiv and bullishDivergence and not na(lastPivotLowBar)
    line.new(
        lastPivotLowBar,
        lastPivotLow,
        bar_index - pivotLookback,
        low[pivotLookback],
        color=color.new(color.green, 0),
        width=2,
        style=line.style_dashed
    )

if showBearishDiv and bearishDivergence and not na(lastPivotHighBar)
    line.new(
        lastPivotHighBar,
        lastPivotHigh,
        bar_index - pivotLookback,
        high[pivotLookback],
        color=color.new(color.red, 0),
        width=2,
        style=line.style_dashed
    )

// ════════════════════════════════════════════════════════════════════════
// ALERTS
// ════════════════════════════════════════════════════════════════════════

if enableAlerts
    if bullishDivergence
        alert("Bullish RSI Divergence detected! Price made lower low but RSI made higher low. Potential reversal up.", alert.freq_once_per_bar_close)
    
    if bearishDivergence
        alert("Bearish RSI Divergence detected! Price made higher high but RSI made lower high. Potential reversal down.", alert.freq_once_per_bar_close)

// ════════════════════════════════════════════════════════════════════════
// INFO TABLE
// ════════════════════════════════════════════════════════════════════════

var table infoTable = table.new(position.top_right, 2, 6, bgcolor=color.new(color.gray, 90), border_width=1)

if barstate.islast and showLabels
    table.cell(infoTable, 0, 0, "RSI Divergence Detector", text_color=color.white, bgcolor=color.new(color.blue, 30))
    table.merge_cells(infoTable, 0, 0, 1, 0)
    
    table.cell(infoTable, 0, 1, "Current RSI:", text_color=color.white)
    rsiColor = rsi > 70 ? color.red : rsi < 30 ? color.green : color.gray
    table.cell(infoTable, 1, 1, str.tostring(rsi, "#.##"), text_color=rsiColor)
    
    table.cell(infoTable, 0, 2, "RSI Status:", text_color=color.white)
    rsiStatus = rsi > 70 ? "Overbought" : rsi < 30 ? "Oversold" : "Neutral"
    table.cell(infoTable, 1, 2, rsiStatus, text_color=rsiColor)
    
    table.cell(infoTable, 0, 3, "Bullish Div:", text_color=color.white)
    table.cell(infoTable, 1, 3, bullishDivergence ? "✓ DETECTED" : "—", text_color=bullishDivergence ? color.green : color.gray)
    
    table.cell(infoTable, 0, 4, "Bearish Div:", text_color=color.white)
    table.cell(infoTable, 1, 4, bearishDivergence ? "✓ DETECTED" : "—", text_color=bearishDivergence ? color.red : color.gray)
    
    table.cell(infoTable, 0, 5, "Lookback:", text_color=color.white)
    table.cell(infoTable, 1, 5, str.tostring(maxLookback) + " bars", text_color=color.gray)
