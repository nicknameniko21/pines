// This source code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © TradingAlerts_All
//@version=5
indicator("Trading Alerts - Comprehensive Signals", overlay=true, max_labels_count=500)

// ═══════════════════════════════════════════════════════════════════════════
// INPUT PARAMETERS
// ═══════════════════════════════════════════════════════════════════════════

// RSI Settings
rsi_length = input.int(14, "RSI Length", minval=1, group="RSI Settings")
rsi_overbought = input.int(70, "RSI Overbought", minval=50, maxval=100, group="RSI Settings")
rsi_oversold = input.int(30, "RSI Oversold", minval=0, maxval=50, group="RSI Settings")
rsi_weight = input.float(1.0, "RSI Weight", minval=0.1, maxval=3.0, step=0.1, group="RSI Settings")

// EMA Settings
ema_fast_length = input.int(9, "Fast EMA Length", minval=1, group="EMA Settings")
ema_slow_length = input.int(21, "Slow EMA Length", minval=1, group="EMA Settings")
ema_trend_length = input.int(50, "Trend EMA Length", minval=1, group="EMA Settings")
ema_weight = input.float(1.0, "EMA Weight", minval=0.1, maxval=3.0, step=0.1, group="EMA Settings")

// Volume Settings
volume_ma_length = input.int(20, "Volume MA Length", minval=1, group="Volume Settings")
volume_threshold = input.float(1.5, "Volume Spike Threshold", minval=1.0, maxval=5.0, step=0.1, group="Volume Settings")
volume_weight = input.float(1.0, "Volume Weight", minval=0.1, maxval=3.0, step=0.1, group="Volume Settings")

// Price Action Settings
candle_body_threshold = input.float(0.5, "Strong Candle Body %", minval=0.1, maxval=1.0, step=0.1, group="Price Action Settings")
price_weight = input.float(1.0, "Price Action Weight", minval=0.1, maxval=3.0, step=0.1, group="Price Action Settings")

// Signal Settings
signal_threshold = input.float(6.0, "Buy/Sell Signal Threshold", minval=1.0, maxval=20.0, step=0.5, group="Signal Settings")
show_table = input.bool(true, "Show Score Table", group="Display Settings")
show_background = input.bool(true, "Show Background Colors", group="Display Settings")
show_signals = input.bool(true, "Show Buy/Sell Signals", group="Display Settings")

// Alert Settings
enable_alerts = input.bool(true, "Enable Alerts", group="Alert Settings")

// ═══════════════════════════════════════════════════════════════════════════
// INDICATOR CALCULATIONS
// ═══════════════════════════════════════════════════════════════════════════

// RSI Calculation
rsi = ta.rsi(close, rsi_length)

// EMA Calculations
ema_fast = ta.ema(close, ema_fast_length)
ema_slow = ta.ema(close, ema_slow_length)
ema_trend = ta.ema(close, ema_trend_length)

// Volume Calculations
volume_ma = ta.sma(volume, volume_ma_length)
volume_spike = volume > volume_ma * volume_threshold

// Price Action Calculations
candle_body = math.abs(close - open)
candle_range = high - low
body_ratio = candle_range > 0 ? candle_body / candle_range : 0

// ═══════════════════════════════════════════════════════════════════════════
// SCORING FUNCTIONS
// ═══════════════════════════════════════════════════════════════════════════

// RSI Score: Returns positive for bullish, negative for bearish
calc_rsi_score() =>
    var float score = 0.0
    if rsi < rsi_oversold
        score := 2.0  // Strong bullish
    else if rsi < 40
        score := 1.0  // Moderate bullish
    else if rsi > rsi_overbought
        score := -2.0  // Strong bearish
    else if rsi > 60
        score := -1.0  // Moderate bearish
    else
        score := 0.0  // Neutral
    score * rsi_weight

// EMA Score: Evaluates trend and crossovers
calc_ema_score() =>
    var float score = 0.0
    
    // Fast/Slow EMA crossover
    fast_above_slow = ema_fast > ema_slow
    fast_above_slow_prev = ema_fast[1] > ema_slow[1]
    
    // Price position relative to trend EMA
    price_above_trend = close > ema_trend
    
    // Bullish conditions
    if fast_above_slow and not fast_above_slow_prev
        score := 2.0  // Golden cross
    else if fast_above_slow and price_above_trend
        score := 1.5  // Strong uptrend
    else if fast_above_slow
        score := 1.0  // Uptrend
    else if price_above_trend
        score := 0.5  // Above trend
    // Bearish conditions
    else if not fast_above_slow and fast_above_slow_prev
        score := -2.0  // Death cross
    else if not fast_above_slow and not price_above_trend
        score := -1.5  // Strong downtrend
    else if not fast_above_slow
        score := -1.0  // Downtrend
    else
        score := -0.5  // Below trend
    
    score * ema_weight

// Volume Score: Confirms price action with volume
calc_volume_score() =>
    var float score = 0.0
    
    bullish_candle = close > open
    bearish_candle = close < open
    
    if volume_spike and bullish_candle
        score := 2.0  // Strong bullish confirmation
    else if volume_spike and bearish_candle
        score := -2.0  // Strong bearish confirmation
    else if volume > volume_ma and bullish_candle
        score := 1.0  // Moderate bullish
    else if volume > volume_ma and bearish_candle
        score := -1.0  // Moderate bearish
    else
        score := 0.0  // Neutral
    
    score * volume_weight

// Price Action Score: Evaluates candle patterns
calc_price_action_score() =>
    var float score = 0.0
    
    strong_body = body_ratio > candle_body_threshold
    bullish_candle = close > open
    bearish_candle = close < open
    
    // Bullish patterns
    if strong_body and bullish_candle and close > high[1]
        score := 2.0  // Strong bullish breakout
    else if strong_body and bullish_candle
        score := 1.5  // Strong bullish candle
    else if bullish_candle
        score := 1.0  // Bullish candle
    // Bearish patterns
    else if strong_body and bearish_candle and close < low[1]
        score := -2.0  // Strong bearish breakdown
    else if strong_body and bearish_candle
        score := -1.5  // Strong bearish candle
    else if bearish_candle
        score := -1.0  // Bearish candle
    else
        score := 0.0  // Neutral (doji)
    
    score * price_weight

// ═══════════════════════════════════════════════════════════════════════════
// AGGREGATE SCORING
// ═══════════════════════════════════════════════════════════════════════════

rsi_score = calc_rsi_score()
ema_score = calc_ema_score()
volume_score = calc_volume_score()
price_score = calc_price_action_score()

// Total Score
total_score = rsi_score + ema_score + volume_score + price_score

// Separate bullish and bearish components for display
bullish_score = math.max(rsi_score, 0) + math.max(ema_score, 0) + math.max(volume_score, 0) + math.max(price_score, 0)
bearish_score = math.abs(math.min(rsi_score, 0)) + math.abs(math.min(ema_score, 0)) + math.abs(math.min(volume_score, 0)) + math.abs(math.min(price_score, 0))

// ═══════════════════════════════════════════════════════════════════════════
// SIGNAL GENERATION
// ═══════════════════════════════════════════════════════════════════════════

buy_signal = total_score >= signal_threshold
sell_signal = total_score <= -signal_threshold

// Prevent signal repetition
var bool in_buy = false
var bool in_sell = false

final_buy_signal = buy_signal and not in_buy
final_sell_signal = sell_signal and not in_sell

if final_buy_signal
    in_buy := true
    in_sell := false

if final_sell_signal
    in_sell := true
    in_buy := false

// Reset state on opposite conditions
if total_score < 0
    in_buy := false
if total_score > 0
    in_sell := false

// ═══════════════════════════════════════════════════════════════════════════
// VISUAL ELEMENTS
// ═══════════════════════════════════════════════════════════════════════════

// Plot EMAs
plot(ema_fast, "Fast EMA", color=color.new(color.blue, 0), linewidth=1)
plot(ema_slow, "Slow EMA", color=color.new(color.orange, 0), linewidth=1)
plot(ema_trend, "Trend EMA", color=color.new(color.purple, 0), linewidth=2)

// Background colors
bgcolor(show_background and total_score > 0 ? color.new(color.green, 90) : na)
bgcolor(show_background and total_score < 0 ? color.new(color.red, 90) : na)

// Buy/Sell signal markers
plotshape(show_signals and final_buy_signal, "Buy Signal", shape.labelup, location.belowbar, color.new(color.green, 0), text="BUY", textcolor=color.white, size=size.normal)
plotshape(show_signals and final_sell_signal, "Sell Signal", shape.labeldown, location.abovebar, color.new(color.red, 0), text="SELL", textcolor=color.white, size=size.normal)

// Score Table
if show_table
    var table score_table = table.new(position.top_right, 3, 7, bgcolor=color.new(color.black, 80), frame_color=color.gray, frame_width=1, border_color=color.gray, border_width=1)
    
    if barstate.islast
        // Headers
        table.cell(score_table, 0, 0, "Component", text_color=color.white, text_size=size.small, bgcolor=color.new(color.gray, 70))
        table.cell(score_table, 1, 0, "Score", text_color=color.white, text_size=size.small, bgcolor=color.new(color.gray, 70))
        table.cell(score_table, 2, 0, "Signal", text_color=color.white, text_size=size.small, bgcolor=color.new(color.gray, 70))
        
        // RSI Row
        table.cell(score_table, 0, 1, "RSI", text_color=color.white, text_size=size.small)
        table.cell(score_table, 1, 1, str.tostring(rsi_score, "#.##"), text_color=rsi_score > 0 ? color.green : rsi_score < 0 ? color.red : color.gray, text_size=size.small)
        table.cell(score_table, 2, 1, rsi_score > 0 ? "↑" : rsi_score < 0 ? "↓" : "→", text_color=rsi_score > 0 ? color.green : rsi_score < 0 ? color.red : color.gray, text_size=size.small)
        
        // EMA Row
        table.cell(score_table, 0, 2, "EMA", text_color=color.white, text_size=size.small)
        table.cell(score_table, 1, 2, str.tostring(ema_score, "#.##"), text_color=ema_score > 0 ? color.green : ema_score < 0 ? color.red : color.gray, text_size=size.small)
        table.cell(score_table, 2, 2, ema_score > 0 ? "↑" : ema_score < 0 ? "↓" : "→", text_color=ema_score > 0 ? color.green : ema_score < 0 ? color.red : color.gray, text_size=size.small)
        
        // Volume Row
        table.cell(score_table, 0, 3, "Volume", text_color=color.white, text_size=size.small)
        table.cell(score_table, 1, 3, str.tostring(volume_score, "#.##"), text_color=volume_score > 0 ? color.green : volume_score < 0 ? color.red : color.gray, text_size=size.small)
        table.cell(score_table, 2, 3, volume_score > 0 ? "↑" : volume_score < 0 ? "↓" : "→", text_color=volume_score > 0 ? color.green : volume_score < 0 ? color.red : color.gray, text_size=size.small)
        
        // Price Action Row
        table.cell(score_table, 0, 4, "Price Action", text_color=color.white, text_size=size.small)
        table.cell(score_table, 1, 4, str.tostring(price_score, "#.##"), text_color=price_score > 0 ? color.green : price_score < 0 ? color.red : color.gray, text_size=size.small)
        table.cell(score_table, 2, 4, price_score > 0 ? "↑" : price_score < 0 ? "↓" : "→", text_color=price_score > 0 ? color.green : price_score < 0 ? color.red : color.gray, text_size=size.small)
        
        // Separator
        table.cell(score_table, 0, 5, "─────────", text_color=color.gray, text_size=size.small)
        table.cell(score_table, 1, 5, "─────", text_color=color.gray, text_size=size.small)
        table.cell(score_table, 2, 5, "─────", text_color=color.gray, text_size=size.small)
        
        // Total Row
        total_color = total_score >= signal_threshold ? color.new(color.green, 0) : total_score <= -signal_threshold ? color.new(color.red, 0) : color.gray
        table.cell(score_table, 0, 6, "TOTAL", text_color=color.white, text_size=size.normal, bgcolor=color.new(color.gray, 70))
        table.cell(score_table, 1, 6, str.tostring(total_score, "#.##"), text_color=total_color, text_size=size.normal, bgcolor=color.new(color.gray, 70))
        table.cell(score_table, 2, 6, total_score >= signal_threshold ? "BUY" : total_score <= -signal_threshold ? "SELL" : "HOLD", text_color=total_color, text_size=size.normal, bgcolor=color.new(color.gray, 70))

// ═══════════════════════════════════════════════════════════════════════════
// ALERTS
// ═══════════════════════════════════════════════════════════════════════════

if enable_alerts
    if final_buy_signal
        alert("BUY Signal: Total Score = " + str.tostring(total_score, "#.##") + "\nRSI=" + str.tostring(rsi_score, "#.##") + " EMA=" + str.tostring(ema_score, "#.##") + " Vol=" + str.tostring(volume_score, "#.##") + " Price=" + str.tostring(price_score, "#.##"), alert.freq_once_per_bar)
    
    if final_sell_signal
        alert("SELL Signal: Total Score = " + str.tostring(total_score, "#.##") + "\nRSI=" + str.tostring(rsi_score, "#.##") + " EMA=" + str.tostring(ema_score, "#.##") + " Vol=" + str.tostring(volume_score, "#.##") + " Price=" + str.tostring(price_score, "#.##"), alert.freq_once_per_bar)

// ═══════════════════════════════════════════════════════════════════════════
// PLOTS FOR DEBUGGING (optional - can be commented out)
// ═══════════════════════════════════════════════════════════════════════════

// Plot scores in a separate pane if needed
// plot(total_score, "Total Score", color=color.yellow, display=display.none)
// plot(bullish_score, "Bullish Score", color=color.green, display=display.none)
// plot(bearish_score, "Bearish Score", color=color.red, display=display.none)
